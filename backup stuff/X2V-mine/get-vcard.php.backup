<?php
/* --------------------------------------------

Brian Suda
brian@suda.co.uk
20-Sept-2004

version 1.0

NOTES:
This required PHP XSLT libraries installed


--------------------------------------------- */

$uri='';
if (isSet($_GET['referer'])) {
  if (getenv("HTTP_REFERER") != ''){ $uri = getenv("HTTP_REFERER"); }
}

if (isSet($_GET['e'])) { 
  switch ($_GET['e']){
    case 'u8': $outputEncoding = 'UTF-8'; break;
    case 'u16': $outputEncoding = 'UTF-16LE'; break;
    case 'UTF-16': $outputEncoding = 'UTF-16LE'; break;
    default: $outputEncoding = $_GET['e'];
  }
 } else { $outputEncoding = 'UTF-16LE'; }

if (isSet($_GET['uri'])){
  if ($_GET['uri'] != ''){ $uri = $_GET['uri']; }
}


if ($uri != '') {

if (isSet($_GET['filename'])){
  if ($_GET['filename'] != ''){ $logfile = $_GET['filename']; } 
} else {$logfile = "X2V.vcf";}


list($temp,$anchor) = explode("#",$uri);

$handle = fopen($uri, "r");
$xml = '';
while (!feof($handle)) {
  $xml .= fread($handle, 8192);
}
fclose($handle);

if (isSet($_GET['beta'])){
$filename = "xhtml2vcard-beta.xsl";
} else { $filename = "xhtml2vcard.xsl"; }
$handle2 = fopen($filename, "r");
$xsl = fread($handle2, filesize($filename));
fclose($handle2);


$Str = '';
$xp = xslt_create() or trigger_error('Could not create XSLT process.',E_USER_ERROR);
xslt_set_encoding($xp, 'UTF-8');

// read the files into memory
$xsl_string = $xsl;
$xml_string = $xml;

// set the argument buffer
$arg_buffer = array('/xml' => $xml_string, '/xsl' => $xsl_string);

// set the parameter buffer
$xsl_params = array('x-from-url'=>$uri,'x-anchor'=>$anchor);


// process the two files to get the desired output
if (($Str = @xslt_process($xp, 'arg:/xml', 'arg:/xsl', NULL, 
$arg_buffer, $xsl_params))){
   $Str = mb_convert_encoding($Str,$outputEncoding,'UTF-8');

   Header("Content-Disposition: attachment; filename=$logfile");
   Header("Content-Length: ".mb_strlen($Str)+1);
   Header("Connection: close");
   Header("Content-Type: text/x-text; name=$logfile");
//   Header("Content-Type: text/x-vcard; name=$logfile");
//   echo $Str;
if ($outputEncoding == "UTF-16LE") { echo chr(255).chr(254); } 
echo $Str;
} else {
  $handle = fopen("http://cgi.w3.org/cgi-bin/tidy?docAddr=".urlencode($uri), "r");
  $xml = '';
  while (!feof($handle)) {
    $xml .= fread($handle, 8192);
  }
  fclose($handle);

  // read the files into memory
  $xsl_string = $xsl;
  $xml_string = $xml;

  // set the argument buffer
  $arg_buffer = array('/xml' => $xml_string, '/xsl' => $xsl_string);

  if (($Str = xslt_process($xp, 'arg:/xml', 'arg:/xsl', NULL, $arg_buffer, NULL))){
   $Str = mb_convert_encoding($Str,$outputEncoding,'UTF-8');

   Header("Content-Disposition: attachment; filename=$logfile");
   Header("Content-Length: ".mb_strlen($Str)+1);
   Header("Connection: close");
   Header("Content-Type: text/x-text; name=$logfile");
//   Header("Content-Type: text/x-vcard; name=$logfile");
//   echo $Str;
if ($outputEncoding == "UTF-16LE") { echo chr(255).chr(254); } 
echo $Str;

} else {
  if (xslt_errno($xp) == 0){
   header("Location: index.php?error=0");
  } else {
   echo "<html><head><title>ERROR</title></head><body>";
   echo "<p>Sorry, $uri could not be transformed by xtml2vcard.xsl into";
   echo " an vCard file because of " . xslt_error($xp);
   echo " and the error code is " . xslt_errno($xp)."";
   echo " check that this page validates: <a href=\"http://validator.w3.org/check?uri=$uri\">http://validator.w3.org/check?uri=$uri</a>";
   echo "</p></body></html>";
  }
}
}

xslt_free($xp);

} else {
// DISPLAY page to manually enter a URL
   Header("Location: index.php");
}

?>